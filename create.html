<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create QR Code | QubR</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="/env.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    input, button { display: block; margin-top: 1rem; padding: 0.5rem; width: 300px; }
    #qr-preview { margin-top: 2rem; }
  </style>
</head>
<body>

<h1>Create QR Code</h1>

<div>
  <label>Folder path (e.g., dir/sub/folder): <input type="text" id="label" /></label>
  <label>Redirect URL: <input type="url" id="redirect_url" /></label>
  <label>Location where shared: <input type="text" id="shared_location" /></label>
  <button id="createBtn">Generate & Save</button>
</div>

<div id="qr-preview"></div>

<script>
const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);

document.getElementById("createBtn").addEventListener("click", async () => {
  const label = document.getElementById("label").value.trim();
  const redirect_url = document.getElementById("redirect_url").value.trim();
  const shared_location = document.getElementById("shared_location").value.trim();
  const qrPreview = document.getElementById("qr-preview");

  if (!redirect_url) {
    alert("Please enter a redirect URL.");
    return;
  }

  const { data: sessionData } = await supabase.auth.getSession();
  const user = sessionData?.session?.user;
  if (!user) {
    alert("Please login to create codes.");
    return;
  }

  const qrId = crypto.randomUUID();
  const fullUrl = `${window.location.origin}/scan?id=${qrId}`;

  // Display QR code
  qrPreview.innerHTML = "";
  new QRCode(qrPreview, {
    text: fullUrl,
    width: 200,
    height: 200
  });

  // Save to DB
  const { error } = await supabase.from("qr_codes").insert({
    id: qrId,
    owner_id: user.id,
    label,
    redirect_url,
    shared_location
  });

  if (error) {
    console.error("Save error:", error);
    alert("❌ Failed to save QR code. Check console.");
  } else {
    alert("✅ QR code created and saved!");
  }
});
</script>

</body>
</html>
