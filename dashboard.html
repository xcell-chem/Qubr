<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QubR Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="/env.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f4f4f4; }
    h2 { margin-top: 2rem; }
    .label { margin-bottom: 2rem; border: 1px solid #ccc; border-radius: 6px; background: #fff; }
    .label-header { background: #e2e2e2; padding: 0.75rem; cursor: pointer; font-weight: bold; }
    .label-content { display: none; padding: 1rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background-color: #f0f0f0; }
    #search { margin-bottom: 1.5rem; padding: 0.5rem; width: 300px; }
    .summary { font-weight: bold; background: #f9f9f9; }
    .export-btn { margin-left: 1rem; font-size: 0.9rem; }
  </style>
</head>
<body>

<h1>ðŸ“Š My QubR Dashboard</h1>
<input type="text" id="search" placeholder="Search QR codes..." />

<div id="labels"></div>
<button onclick="logout()">Log out</button>

<script>
  const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);
  let allCodes = [];

  async function loadDashboard() {
    const { data: sessionData } = await supabase.auth.getSession();
    const session = sessionData.session;
    if (!session?.user) {
      window.location.href = "/scan.html";
      return;
    }

    const user = session.user;

    const { data: qrCodes } = await supabase
      .from("qr_codes")
     // âœ… Corrected:
.select("id, shared_location, redirect_url, label")
 .eq("owner_id", user.id)
      .order("label", { ascending: true });

    const labels = {};
  
    for (const qr of qrCodes) {
      const labelKey = qr.label || "No Folder";

      if (!labels[labelKey]) {
        labels[labelKey] = [];
      }

      const { data: events } = await supabase
        .from("scan_events")
        .select("referred_signup")
        .eq("qr_id", qr.id);

      labels[labelKey].push({
        ...qr,
        scans: events?.length || 0,
        referrals: events?.filter(e => e.referred_signup).length || 0,
      });
    }

    allCodes = labels;
    renderlabels(labels);
  }

  function renderlabels(labeled) {
    const container = document.getElementById("labels");
    container.innerHTML = "";

    for (const label in labeled) {
      const codes = labeled[label];
      const totalScans = codes.reduce((acc, c) => acc + c.scans, 0);
      const totalReferrals = codes.reduce((acc, c) => acc + c.referrals, 0);

      const wrapper = document.createElement("div");
      wrapper.className = "label";

      const header = document.createElement("div");
      header.className = "label-header";
      header.textContent = label + ` (Scans: ${totalScans} | Referrals: ${totalReferrals})`;

      const exportBtn = document.createElement("button");
      exportBtn.className = "export-btn";
      exportBtn.textContent = "Export CSV";
      exportBtn.onclick = () => exportToCSV(label, codes);
      header.appendChild(exportBtn);

      const content = document.createElement("div");
      content.className = "label-content";

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>ID</th>
            <th>Location</th>
            <th>Redirect URL</th>
            <th>Scans</th>
            <th>Referrals</th>
          </tr>
        </thead>
        <tbody>
          ${codes.map(qr => `
            <tr>
              <td>${qr.id}</td>
              <td>${qr.shared_location || ""}</td>
              <td><a href="${qr.redirect_url}" target="_blank">${qr.redirect_url}</a></td>
              <td>${qr.scans}</td>
              <td>${qr.referrals}</td>
            </tr>
          `).join("")}
        </tbody>
      `;

      content.appendChild(table);
      header.onclick = () => {
        content.style.display = content.style.display === "none" ? "block" : "none";
      };

      wrapper.appendChild(header);
      wrapper.appendChild(content);
      container.appendChild(wrapper);
    }
  }

  function exportToCSV(label, data) {
    const csv = [
      ["ID", "Location", "Redirect URL", "Scans", "Referrals"],
      ...data.map(qr => [qr.id, qr.shared_location || "", qr.redirect_url, qr.scans, qr.referrals])
    ]
      .map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(","))
      .join("\\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = label.replaceAll("/", "_") + ".csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function filterlabels() {
    const query = document.getElementById("search").value.toLowerCase();
    const filtered = {};

    for (const label in allCodes) {
      const matches = allCodes[label].filter(code =>
        code.id.toLowerCase().includes(query) ||
        (code.shared_location || "").toLowerCase().includes(query) ||
        (code.label || "").toLowerCase().includes(query)
      );

      if (matches.length > 0) {
        filtered[label] = matches;
      }
    }

    renderlabels(filtered);
  }

  document.getElementById("search").addEventListener("input", filterlabels);

  async function logout() {
    await supabase.auth.signOut();
    window.location.reload();
  }

  loadDashboard();
</script>

</body>
</html>
